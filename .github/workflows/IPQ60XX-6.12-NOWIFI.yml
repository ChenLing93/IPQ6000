name: IPQ60XX-6.12-NOWIFI

on:
  workflow_dispatch:
  schedule:
    - cron: 0 19 * * *

env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: main-nss
  CONFIG_FILE: openwrt.config
  CACHE_TOOLCHAIN: true
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: IPQ60XX-6.12-NOWIFI
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-latest

    steps:
      - name: Check Server Performance(检查服务器性能)
        run: |
          echo "警告⚠"
          echo "分配的服务器性能有限，若选择的插件过多，务必注意CPU性能！"
          echo -e "已知CPU型号（降序）：7763，8370C，8272CL，8171M，E5-2673 \n"
          echo "--------------------------CPU信息--------------------------"
          echo "CPU物理数量：$(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
          echo -e "CPU核心信息：$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
          echo "--------------------------内存信息--------------------------"
          echo "已安装内存详细信息："
          echo -e "$(sudo lshw -short -C memory | grep GiB) \n"
          echo "--------------------------硬盘信息--------------------------"
          echo "硬盘数量：$(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

      - name: Initialization Environment(初始化环境)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo -E apt -yqq install dos2unix
          sudo -E apt -yqq install libfuse-dev
          sudo -E apt -yqq autoremove --purge
          sudo -E apt -yqq autoclean
          sudo -E apt -yqq clean
          sudo -E systemctl daemon-reload
          sudo timedatectl set-timezone "$TZ"

      - name: Combine Disks(合并磁盘)
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          temp-reserve-mb: 100
          root-reserve-mb: 1024

      - name: Checkout
        uses: actions/checkout@main

      - name: Clone Source Code(克隆源代码)
        run: |
          df -hT $GITHUB_WORKSPACE
          git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          VERSION_INFO=$(git show -s --date=short --format="作者: %an时间: %cd内容: %shash: %H")
          echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV
          VERSION_KERNEL=$(grep -oP 'LINUX_KERNEL_HASH-\K[0-9]+\.[0-9]+\.[0-9]+' target/linux/generic/kernel-6.12 2>/dev/null || echo "6.12.69")
          echo "VERSION_KERNEL=$VERSION_KERNEL" >> $GITHUB_ENV

      - name: Load Feeds Configuration(加载Feeds配置)
        run: |
          cd $OPENWRT_PATH

          # 复制增强 feeds 配置
          if [ -f "$GITHUB_WORKSPACE/feeds_theme_enhanced.conf.default" ]; then
            echo "✓ 复制增强 feeds 配置文件..."
            cp $GITHUB_WORKSPACE/feeds_theme_enhanced.conf.default feeds.conf.default
          elif [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
            echo "✓ 复制基础 feeds 配置文件..."
            cp $GITHUB_WORKSPACE/feeds.conf.default feeds.conf.default
          else
            echo "⚠ 未找到 feeds 配置文件，使用源码默认配置"
          fi

          # 显示 feeds 配置
          echo ""
          echo "=== Feeds 配置内容 ==="
          cat feeds.conf.default
          echo "======================"
          echo ""

      - name: Install Feeds(安装feeds)
        run: |
          cd $OPENWRT_PATH
          echo "=== 开始更新 Feeds ==="
          ./scripts/feeds update -a
          echo "=== Feeds 更新完成 ==="
          echo ""

          echo "=== 验证关键包 ==="
          if [ -d "feeds/luci/luci-theme-proton2025" ]; then
            echo "✓ Proton2025 主题已安装"
          else
            echo "✗ Proton2025 主题未找到"
          fi

          if [ -d "feeds/packages/istore" ] || [ -d "feeds/luci/istore" ]; then
            echo "✓ iStore 已安装"
          else
            echo "✗ iStore 未找到"
          fi

          if [ -d "feeds/packages/gecoosac" ] || [ -d "feeds/luci/applications/luci-app-gecoos-ac" ]; then
            echo "✓ GecoOS AC 已安装"
          else
            echo "✗ GecoOS AC 未找到"
          fi

          if [ -d "feeds/luci/luci-theme-argon" ]; then
            echo "✓ Argon 主题已安装"
          else
            echo "✗ Argon 主题未找到"
          fi

          if [ -d "feeds/luci/luci-theme-aurora" ]; then
            echo "✓ Aurora 主题已安装"
          else
            echo "✗ Aurora 主题未找到"
          fi
          echo "======================"

          echo "=== 开始安装 Feeds ==="
          ./scripts/feeds install -a
          echo "=== Feeds 安装完成 ==="
          echo ""

      - name: Generate Variables(生成变量)
        run: |
          if [ -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
            cp $GITHUB_WORKSPACE/$CONFIG_FILE $OPENWRT_PATH/.config
          else
            echo "⚠ 未找到 $CONFIG_FILE，使用源码默认配置"
          fi

          cd $OPENWRT_PATH
          make defconfig > /dev/null 2>&1

          SOURCE_REPO="$(echo $REPO_URL | awk -F '/' '{print $(NF)}')"
          echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV

          DEVICE_TARGET=$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
          echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV

          DEVICE_SUBTARGET=$(cat .config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')
          echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV

      - name: Cache Toolchain(缓存工具链)
        if: env.CACHE_TOOLCHAIN == 'true'
        uses: HiGarfield/cachewrtbuild@main
        with:
          ccache: false
          mixkey: ${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
          prefix: ${{ env.OPENWRT_PATH }}

      - name: Download DL Package(下载DL软件包)
        run: |
          cd $OPENWRT_PATH
          make defconfig
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile Firmware(开始编译固件)
        id: compile
        run: |
          cd $OPENWRT_PATH
          echo -e "$(nproc) thread compile"

          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
          echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

      - name: Check Space Usage(检查空间使用情况)
        if: (!cancelled())
        run: df -hT

      - name: Upload Bin Directory(上传固件)
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        uses: actions/upload-artifact@main
        with:
          name: ${{ env.SOURCE_REPO }}-bin-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.OPENWRT_PATH }}/bin

      - name: Organize Files(整理文件)
        if: steps.compile.outputs.status == 'success'
        run: |
          cd $OPENWRT_PATH/bin/targets/*/*
          cat sha256sums
          echo "VERSION_KERNEL=$(find -type f -name "*.manifest" -exec grep -oP '^kernel - \K.*?(?=~|-\d+-)' {} \;)" >> $GITHUB_ENV
          cp $OPENWRT_PATH/.config build.config
          mv -f $OPENWRT_PATH/bin/packages/*/*/*.ipk packages 2>/dev/null || true
          tar -zcf Packages.tar.gz packages 2>/dev/null || true
          rm -rf packages feeds.buildinfo version.buildinfo 2>/dev/null || true
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV

      - name: Upload Firmware To Artifact(将固件上传到Artifact)
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE != 'true'
        uses: actions/upload-artifact@main
        with:
          name: ${{ env.SOURCE_REPO }}-firmware-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE_PATH }}

      - name: Upload Firmware To Release(发布固件)
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
        uses: ncipollo/release-action@v1
        with:
          name: R${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
          allowUpdates: true
          tag: ${{ env.FIRMWARE_TAG }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            **This is OpenWrt Firmware for ${{ env.FIRMWARE_TAG }}**

            ### 📒 固件信息(无WIFI)
            - 无WIFI带有线NSS的6.12内核固件
            - 基于B大的自用固件 稳定性未知
            - 💻 这是 ${{ env.FIRMWARE_TAG }} 平台使用的 OpenWrt 固件
            - ⚽ 固件源码: ${{ env.REPO_URL }}
            - 💝 源码分支: ${{ env.REPO_BRANCH }}
            - 🌐 默认地址: 192.168.5.1
            - 🔑 默认密码: password

            ### 🧊 固件版本
            - 固件内核版本：${{ env.VERSION_KERNEL }}
            - 固件编译前最后一次➦[主源码](${{ env.REPO_URL }})更新记录
            - ${{ env.VERSION_INFO }}

            ### 🎨 集成主题
            - ✅ Proton2025 主题（深色玻璃设计）
            - ✅ Argon 主题（经典王者）
            - ✅ Aurora 主题（现代极简）
            - ✅ KuCat 主题（功能丰富）
            - ✅ Neobird 主题（移动优先）
            - ✅ Bootstrap 主题（官方基础）

            ### 🔧 集成插件
            - ✅ OpenClash（唯一代理工具）
            - ✅ iStore 软件中心
            - ✅ GecoOS AC 无线控制器
            - ✅ SmartDNS（DNS 优化）
            - ✅ DDNSTO（远程管理）
            - ✅ Docker 容器支持
            - ✅ 5G 模块支持（QMI/SMS）
            - ✅ WireGuard VPN
            - ✅ 多WAN 支持
            - ✅ 在线用户管理
            - ✅ 定时自动重启

            ### 🚀 核心功能
            - ✅ NSS 硬件加速（IGS、MAPT、PPTP、SHAPER）
            - ✅ Btrfs 文件系统支持
            - ✅ UPnP 端口映射
            - ✅ WOL 网络唤醒
            - ✅ ARP 绑定
            - ✅ USB 存储支持
            - ✅ 系统监控（htop/ttyd）

            ### 📦 已移除功能
            - ❌ CUPS 打印服务器（减少编译负担）
            - ❌ PassWall 代理工具（避免与 OpenClash 冲突）
            - ❌ HomeProxy 代理工具（避免与 OpenClash 冲突）

            ### 📝 使用方法
            1. 下载对应的固件文件
            2. 登录路由器管理界面
            3. 进入 系统 → 备份与升级
            4. 上传固件文件（取消勾选"保留配置"）
            5. 等待升级完成

            ### ⚠️ 注意事项
            - 首次刷机时请勿保留配置
            - 建议使用 U-Boot 刷机
            - 刷机过程中请勿断电
            - 本固件仅支持有线网络，不包含 WiFi 功能

            ---
            **Powered by GitHub Actions**
